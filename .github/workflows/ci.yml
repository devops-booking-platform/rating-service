name: Rating Service CI

on:
  push:
    branches: [develop, main]
    tags:
      - 'v*.*.*'
  pull_request:
    branches: [develop, main]

permissions:
  contents: read
  packages: write

env:
  DOTNET_VERSION: "8.0.x"
  SOLUTION_PATH: "./RatingService/RatingService.sln"

jobs:
  build_test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Cache NuGet packages
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore
        run: dotnet restore ${{ env.SOLUTION_PATH }}

      - name: Build
        run: dotnet build ${{ env.SOLUTION_PATH }} --no-restore --configuration Release

      - name: Test
        run: dotnet test ${{ env.SOLUTION_PATH }} --configuration Release --no-restore --no-build --verbosity normal

  docker_build_pr:
    needs: build_test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Docker build (no push) - verify Dockerfile
        run: |
          docker build -t rating-service:pr -f RatingService/RatingService/Dockerfile RatingService/RatingService

  containerize_kaniko:
    needs: build_test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref_name == 'develop' || github.ref_name == 'main' || startsWith(github.ref, 'refs/tags/v'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Extract semantic version from git tag or generate dev version
      - name: Generate Version Tags
        id: meta
        shell: bash
        run: |
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          REPO_LC="$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')"
          IMAGE_NAME="ghcr.io/${OWNER_LC}/${REPO_LC}"
          
          echo "image=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          
          TAGS="${IMAGE_NAME}:sha-${GITHUB_SHA::7}"
          
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Tagged release - extract semantic version
            VERSION=${GITHUB_REF#refs/tags/v}
            TAGS="${TAGS},${IMAGE_NAME}:${VERSION}"
            TAGS="${TAGS},${IMAGE_NAME}:latest"
            
            # Also tag major and minor versions (e.g., v1.2.3 -> 1, 1.2, 1.2.3)
            MAJOR=$(echo ${VERSION} | cut -d. -f1)
            MINOR=$(echo ${VERSION} | cut -d. -f1-2)
            TAGS="${TAGS},${IMAGE_NAME}:${MAJOR}"
            TAGS="${TAGS},${IMAGE_NAME}:${MINOR}"
          else
            # Branch push - use branch name
            TAGS="${TAGS},${IMAGE_NAME}:${{ github.ref_name }}"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "Container Image tags: ${TAGS}"

      - name: Kaniko build & push (GHCR) with caching
        shell: bash
        run: |
          DOCKERFILE="RatingService/RatingService/Dockerfile"
          CONTEXT="RatingService/RatingService"

          mkdir -p "${{ github.workspace }}/kaniko-docker"
          cat > "${{ github.workspace }}/kaniko-docker/config.json" <<EOF
          {
            "auths": {
              "ghcr.io": {
                "username": "${{ github.actor }}",
                "password": "${{ secrets.GITHUB_TOKEN }}"
              }
            }
          }
          EOF

          # Convert comma-separated tags to multiple --destination flags
          DESTINATIONS=""
          IFS=',' read -ra TAG_ARRAY <<< "${{ steps.meta.outputs.tags }}"
          for TAG in "${TAG_ARRAY[@]}"; do
            DESTINATIONS="${DESTINATIONS} --destination ${TAG}"
          done

          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v "${{ github.workspace }}/kaniko-docker:/kaniko/.docker" \
            gcr.io/kaniko-project/executor:latest \
            --context "/workspace/${CONTEXT}" \
            --dockerfile "/workspace/${DOCKERFILE}" \
            ${DESTINATIONS} \
            --cache=true \
            --cache-repo="${{ steps.meta.outputs.image }}/cache" \
            --compressed-caching=false
